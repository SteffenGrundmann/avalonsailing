<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html><head>
<title>Control</title>
</head>

<body onload="start()" onkeydown="handlekey()">
<a href="control.html" target="control" style="background:gray;">Control</a>
<a href="plan.html" target="plan">Plan</a>
<a href="log.html" target="log">Log</a>


<div id="widget" style="position: relative;  left:100;" >
<img id="boat"   width="208" height="495" style="position: absolute; left: 0; top: 0;" src="boat.png"/>
  
<img id="sts_sail"   width="41" height="289" style="position: absolute; left: 80; top: 200;" src="boom.png"/>
<img id="ctl_sail"   width="30" height="289" style="position: absolute; left: 80; top: 200;" src="needle.png"/>
<img id="sts_rudd_l" width="10" height="60"  style="position: absolute; left: 60; top: 490;" src="boom.png"/>
<img id="ctl_rudd_l" width="8" height="80"   style="position: absolute; left: 60; top: 490;" src="needle.png"/>
<img id="sts_rudd_r" width="10" height="60"  style="position: absolute; left: 140; top: 490;" src="boom.png"/>
<img id="ctl_rudd_r" width="8" height="80"   style="position: absolute; left: 140; top: 490;" src="needle.png"/>

<img id="sns_wind"   width="20" height="100" style="position: absolute; left: 80; top: 200;" src="dashed.png"/>
<img id="sns_compass"  width="240" height="240"style="position: absolute; left: 440; top: 50;" src="rose.png"/>
<img id="sns_imuyaw"  width="240" height="240"style="position: absolute; left: 440; top: 350;" src="rose.png"/>
</div>

<script>
var sts_sail, sts_rudd_l, sts_rudd_r
var ctl_sail, ctl_rudd_l, ctl_rudd_r
var sns_wind, sns_compass, sns_imuyaw

var ws

var lastmsg = {}

function get_lastctl() {
    var x = lastmsg['rudderctl']
    if (x != null) return x
    return { 'timestamp_ms':0, 'rudder_l_deg':0, 'rudder_r_deg':0, 'sail_deg':0, }
}

function set_lastctl(x) {
    lastmsg['rudderctl'] = x
    handlers['rudderctl'](x)
}

function fmt_rudderctl(x) {
    return "rudderctl: timestamp_ms:" + x.timestamp_ms + " rudder_l_deg:" + x.rudder_l_deg + " rudder_r_deg:" + x.rudder_r_deg + " sail_deg:" + x.sail_deg + "\n"
}

function e(id) { return document.getElementById(id) }
function rot(id, angle) { e(id).style['-webkit-transform'] ='rotate(' + angle + 'deg)' }

function start() {
    e('sts_sail')   .style['-webkit-transform-origin'] ='top'
    e('sts_rudd_l') .style['-webkit-transform-origin'] ='top'
    e('sts_rudd_r') .style['-webkit-transform-origin'] ='top'
    e('ctl_sail')   .style['-webkit-transform-origin'] ='top'
    e('ctl_rudd_l') .style['-webkit-transform-origin'] ='top'
    e('ctl_rudd_r') .style['-webkit-transform-origin'] ='top'
    e('sns_wind') .style['-webkit-transform-origin'] ='top'

    var nan = Number.NaN

    ws = new WebSocket("ws://" + window.location.host + "/lbus");
    ws.onmessage = function (evt) {
	var msg = eval('('+evt.data+')')
	if (msg == null) return
	alert(JSON.stringify(msg, undefined, 2))
        for (x in msg) {
	    f = handlers[x]
            if (f != null) f(msg[x])
	    lastmsg[x] = msg[x]
        }

    };

    ws.onclose = function(err) { document.body.style.background = 'darkgrey' }
    ws.onerror = function(err) { document.body.style.background = 'red' }
}

var handlers = {
    'ruddersts': function(msg) {
	rot('sts_rudd_l', msg.rudder_l_deg)
	rot('sts_rudd_r', msg.rudder_r_deg)
	rot('sts_sail', msg.sail_deg)
    },
    'rudderctl': function(msg) {
	rot('ctl_rudd_l', msg.rudder_l_deg)
	rot('ctl_rudd_r', msg.rudder_r_deg)
	rot('ctl_sail', msg.sail_deg)
    },
    'status_left':  function(msg) { rot('sts_rudd_l', msg.angle_deg) },
    'status_right': function(msg) { rot('sts_rudd_r', msg.angle_deg) },
    'status_sail':  function(msg) { rot('sts_sail', msg.angle_deg) },
    'wind': 	    function(msg) { rot('sns_wind', msg.angle_deg) },
    'compass': 	    function(msg) { rot('sns_compass', -msg.yaw_deg) },
    'imu':	    function(msg) { rot('sns_imuyaw',  -msg.yaw_deg) },
}

var keys = {
    32: function(msg) {  // Space
	msg.rudder_l_deg = 0
	msg.rudder_r_deg = 0
	msg.sail_deg = 0
	return msg
    },

    65: function(msg) {  // 'A'
	msg.rudder_l_deg += 5
	msg.rudder_r_deg += 5
	return msg
    },
    83: function(msg) {  // 'S'
	msg.rudder_l_deg = 0
	msg.rudder_r_deg = 0
	return msg
    },
    68: function(msg) {  // 'D'
	msg.rudder_l_deg -= 5
	msg.rudder_r_deg -= 5
	return msg
    },

    72: function(msg) {  // 'H'
	msg.sail_deg += 20
	return msg
    },
    74: function(msg) {  // 'J'
	msg.sail_deg += 5
	return msg
    },
    75: function(msg) {  // 'K'
	msg.sail_deg -= 5
	return msg
    },
    76: function(msg) {  // 'L'
	msg.sail_deg -= 20
	return msg
    },


}


function handlekey() {

    f = keys[event.keyCode]
    if (f != null) {
	msg = get_lastctl()
	msg = f(msg)
	set_lastctl(msg)
	ws.send(fmt_rudderctl(msg)) 
    }
    return true
}

</script>
</body> </html>
